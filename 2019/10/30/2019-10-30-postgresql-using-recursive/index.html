<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>PostgreSQL查询中使用递归 | L2M2</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-8434506781518741", enable_page_level_ads: true});</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PostgreSQL查询中使用递归</h1><a id="logo" href="/.">L2M2</a><p class="description">把简单的事情做好</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">PostgreSQL查询中使用递归</h1><div class="post-meta">Oct 30, 2019<span> | </span><span class="category"><a href="/categories/数据库/">数据库</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="WITH查询"><a href="#WITH查询" class="headerlink" title="WITH查询"></a>WITH查询</h2><p>官网对<code>WITH</code>的解释：</p>
<p>WITH provides a way to write auxiliary statements for use in a larger query. These statements, which are often referred to as Common Table Expressions or CTEs, can be thought of as defining temporary tables that exist just for one query. Each auxiliary statement in a WITH clause can be a SELECT, INSERT, UPDATE, or DELETE; and the WITH clause itself is attached to a primary statement that can also be a SELECT, INSERT, UPDATE, or DELETE.</p>
<p> <code>WITH</code>提供了一种方式来书写在一个大型查询中使用的辅助语句。这些语句通常被称为公共表表达式或CTE，它们可以被看成是定义只在一个查询中存在的临时表。在<code>WITH</code>子句中的每一个辅助语句可以是一个<code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>或<code>DELETE</code>，并且<code>WITH</code>子句本身也可以被附加到一个主语句，主语句也可以是<code>SELECT</code>、<code>INSERT</code>、<code>UPDATE</code>或<code>DELETE</code>。 </p>
<p>我们来看一个例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WITH regional_sales AS (</span><br><span class="line">    SELECT region, SUM(amount) AS total_sales</span><br><span class="line">    FROM orders</span><br><span class="line">    GROUP BY region</span><br><span class="line">), top_regions AS (</span><br><span class="line">    SELECT region</span><br><span class="line">    FROM regional_sales</span><br><span class="line">    WHERE total_sales &gt; (SELECT SUM(total_sales)/10 FROM regional_sales)</span><br><span class="line">)</span><br><span class="line">SELECT region,</span><br><span class="line">       product,</span><br><span class="line">       SUM(quantity) AS product_units,</span><br><span class="line">       SUM(amount) AS product_sales</span><br><span class="line">FROM orders</span><br><span class="line">WHERE region IN (SELECT region FROM top_regions)</span><br><span class="line">GROUP BY region, product;</span><br></pre></td></tr></table></figure>

<p> 它只显示在高销售区域每种产品的销售总额。<code>WITH</code>子句定义了两个辅助语句<code>regional_sales</code>和<code>top_regions</code>，其中<code>regional_sales</code>的输出用在<code>top_regions</code>中而<code>top_regions</code>的输出用在主<code>SELECT</code>查询。这个例子可以不用<code>WITH</code>来书写，但是我们必须要用两层嵌套的子<code>SELECT</code>。使用这种方法要更简单些。 </p>
<h2 id="递归查询"><a href="#递归查询" class="headerlink" title="递归查询"></a>递归查询</h2><p>下面的例子是计算从1到100的整数的总和的查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WITH RECURSIVE t(n) AS (</span><br><span class="line">    VALUES (1)</span><br><span class="line">  UNION ALL</span><br><span class="line">    SELECT n+1 FROM t WHERE n &lt; 100</span><br><span class="line">)</span><br><span class="line">SELECT sum(n) FROM t;</span><br></pre></td></tr></table></figure>

<p>我们再来玩一个产生<a href="https://en.wikipedia.org/wiki/Fibonacci_number" target="_blank" rel="noopener">斐波那契数列</a>的例子。</p>
<p>斐波那契数列由0和1开始，之后的斐波那契系数就是由之前的两数相加而得出。</p>
<p>注意”0”是省略掉的，所以数列长这个样子：</p>
<p>(0, ), 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, …</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WITH RECURSIVE r ( a, b ) AS ( </span><br><span class="line">	SELECT 0::INT, 1::INT </span><br><span class="line">	UNION ALL </span><br><span class="line">	SELECT b, a + b FROM r </span><br><span class="line">	WHERE b &lt; 1000 </span><br><span class="line">) </span><br><span class="line">SELECT b FROM r;</span><br></pre></td></tr></table></figure>

<p>我们可以这样理解，r (a, b) 是一个包含a, b 两列的临时表，后面的语句是为了迭代产生临时表的数据。</p>
<p><strong>我们再来看一个实际项目中的例子。</strong></p>
<p>有一张<code>mes_workcenter</code>表，用来表示MES系统中的工作中心，此处的工作中心是一个宽泛的概念，它可以是工厂，也可以是产线，机器，工位。</p>
<p>工作中心表有三个字段（为了更方便演示省略了其他字段），id, name, parent_id。分别表示工作中心的编号，名称，父工作中心的ID。它的数据示例如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>parent_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>L2M2集团</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>L2M2成都有限公司</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>成都一厂</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>包装部</td>
<td>3</td>
</tr>
<tr>
<td>5</td>
<td>产线一</td>
<td>4</td>
</tr>
<tr>
<td>6</td>
<td>产线二</td>
<td>4</td>
</tr>
</tbody></table>
<p>我们要查询L2M2集团下所有的工作中心，以及工作中心的子工作中心，以此类推。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WITH RECURSIVE t(id) AS (</span><br><span class="line">	SELECT id FROM mes_workcenter</span><br><span class="line">	WHERE name = &apos;L2M2集团&apos;</span><br><span class="line">	UNION ALL</span><br><span class="line">	SELECT B.id FROM t</span><br><span class="line">	INNER JOIN mes_workcenter AS B ON B.parent_id = t.id</span><br><span class="line">)</span><br><span class="line">SELECT * FROM t</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.postgres.cn/docs/10/queries-with.html" target="_blank" rel="noopener">http://www.postgres.cn/docs/10/queries-with.html</a> </li>
<li><a href="https://www.postgresql.org/docs/10/queries-with.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/10/queries-with.html</a> </li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://l2m2.top/2019/10/30/2019-10-30-postgresql-using-recursive/" data-id="cm8istlvy001legq6zxmu2bpp" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACqklEQVR42u3a0WpbMRAEUP//T7fQp0Jre0ardVJ67lOwkysdBVbLSI9H/Pz49eTf3v3k9+ex8eDh4eEdTf3Z8+fA+e/kjGThXs/h6RLg4eHhrfHOXt1OIl+IfMQ3Fjw8PLwv5bWlP/8874fx8PDw/i3erY3kbCw8PDy878ZLwog2zD0r7q9ntZi14OHh4cW8eZz6+Z8Xz/fw8PDwBqfqSdktWtuXkcTZNYI388TDw8Nb4E2i1aRdPlumNiB+M3M8PDy8q7xkyLb0txe2boH/8gkeHh7eGq8NICbNdLsQSYV/OjoeHh7eAm9yEHV2GDZ/c72UeHh4eFd5SbN7dpy/V/qT+ePh4eF9njcPF/LWvC36xSh4eHh4a7xJUW63inybacORx3wAPDw8vDKGSEp/O1gOyDebfFw8PDy8bV4b6SZt9+SQLL8i8BSMh4eHt8BrG+UWlr8tv6bQXmbFw8PDu8s7iyGuxaxHf1uA8fDw8BZ4eaPcFvrJ+ychBR4eHt42ry3EyTWpfJtpG/H6GA8PDw9vmZfnFm1U0UbGecDx5rgODw8P7yO8vDnOw9lrVwHaKw54eHh4C7x5a3sGmCzTo33w8PDwrvLO2tx8EknRT5YgiUie7nt4eHh4V3l5IDs/JMsXMQcX/0M8PDy8q7xJFT2Lbifvydl4eHh4e7y2jc4Pq25dO0g2kjdZNR4eHt4yLynok+y03q/KtHZxQnh4eP89b3IcdRbOJkf+bQP99G14eHh4C7z5Kfzr1yX4CfXaNoOHh4dX8trNIA+Ck2J9FnPki4KHh4e3x5sf5N9qu9u9K9oY8PDw8L4lb97Hnm0Gb5YSDw8P70t5eeFOGuX26kBLxcPDw9vmtQPXocBR+JvMre648fDw8Ma89gCsHX7eOrczwcPDw1vj/QThH7GG5Jy59gAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/PostgreSQL/">PostgreSQL</a><a href="/tags/SQL/">SQL</a></div><div class="post-nav"><a class="pre" href="/2019/10/31/2019-10-31-postgresql-cte-is-automic/">PostgreSQL - CTE的原子性</a><a class="next" href="/2019/10/23/2019-10-23-qt-rtti-dont-using-qobjectcast/">Qt中用qobject_cast&lt;&gt;进行RTTI时需注意</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '063f09497ab2295cd574',
  clientSecret: '511f140355c2df260b5b0f85f1e8decdf4eeb1a3',
  repo: 'l2m2.github.io',
  owner: 'l2m2',
  admin: ['l2m2'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://l2m2.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web前端/">Web前端</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">31</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Vuetify/" style="font-size: 15px;">Vuetify</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/面试题目/" style="font-size: 15px;">面试题目</a> <a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/Qt/" style="font-size: 15px;">Qt</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/VS-Code/" style="font-size: 15px;">VS Code</a> <a href="/tags/H5/" style="font-size: 15px;">H5</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a> <a href="/tags/PostgreSQL/" style="font-size: 15px;">PostgreSQL</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/MSSQL/" style="font-size: 15px;">MSSQL</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/GitLab/" style="font-size: 15px;">GitLab</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/MacOS/" style="font-size: 15px;">MacOS</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/pdf/" style="font-size: 15px;">pdf</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/Wall/" style="font-size: 15px;">Wall</a> <a href="/tags/Casbin/" style="font-size: 15px;">Casbin</a> <a href="/tags/TOML/" style="font-size: 15px;">TOML</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/PM2/" style="font-size: 15px;">PM2</a> <a href="/tags/WordPress/" style="font-size: 15px;">WordPress</a> <a href="/tags/OCR/" style="font-size: 15px;">OCR</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/Vue-js/" style="font-size: 15px;">Vue.js</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/SQLAlchemy/" style="font-size: 15px;">SQLAlchemy</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/iconfont/" style="font-size: 15px;">iconfont</a> <a href="/tags/Verdaccio/" style="font-size: 15px;">Verdaccio</a> <a href="/tags/MFC/" style="font-size: 15px;">MFC</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/NSIS/" style="font-size: 15px;">NSIS</a> <a href="/tags/Duilib/" style="font-size: 15px;">Duilib</a> <a href="/tags/VSTO/" style="font-size: 15px;">VSTO</a> <a href="/tags/PowerPoint插件/" style="font-size: 15px;">PowerPoint插件</a> <a href="/tags/COM/" style="font-size: 15px;">COM</a> <a href="/tags/VBScript/" style="font-size: 15px;">VBScript</a> <a href="/tags/Office/" style="font-size: 15px;">Office</a> <a href="/tags/MSVC/" style="font-size: 15px;">MSVC</a> <a href="/tags/wkhtmltopdf/" style="font-size: 15px;">wkhtmltopdf</a> <a href="/tags/OpenCV/" style="font-size: 15px;">OpenCV</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/SikuliX/" style="font-size: 15px;">SikuliX</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/ChatGPT/" style="font-size: 15px;">ChatGPT</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Midjourney/" style="font-size: 15px;">Midjourney</a> <a href="/tags/AutoIt/" style="font-size: 15px;">AutoIt</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/QML/" style="font-size: 15px;">QML</a> <a href="/tags/WSL/" style="font-size: 15px;">WSL</a> <a href="/tags/权限设计/" style="font-size: 15px;">权限设计</a> <a href="/tags/cef/" style="font-size: 15px;">cef</a> <a href="/tags/CMake/" style="font-size: 15px;">CMake</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/12/19/2024-12-19-windows-xp-vmware-expire/">解决VMware虚拟机中的Windows XP到期无法使用的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/19/2024-11-19-systemctl-on-wsl/">解决WSL的CentOS无法正常使用systemctl</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/06/2024-08-06-use-pg_partman/">windows下使用pg_partman实现PostgreSQL 15自动分区</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/02/2024-02-02-qml-row-vs-rowlayout/">QML中的Row与RowLayout</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/11/21/2023-11-21-qt-charts-for-5.6/">Qt5.6编译QtCharts</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/26/2023-06-26-retinanet-training/">基于RetinaNet训练模型以及检测图像中的对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/21/2023-06-21-imageai-custom-training/">使用ImageAI训练自定义模型以及检测图像中的对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/18/2023-05-18-autoit-access-db/">AutoIt操作Access数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/12/2023-05-12-autoit-postgresql/">AutoIt操作PostgreSQL数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/10/2023-05-10-qt-for-android-env-build/">搭建Qt for Android开发环境</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://wuming.me/" title="无名的旅人" target="_blank">无名的旅人</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">L2M2.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>