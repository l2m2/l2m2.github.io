<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>基于Vue.js的后台管理系统的权限实现 | L2M2</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({google_ad_client: "ca-pub-8434506781518741", enable_page_level_ads: true});</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于Vue.js的后台管理系统的权限实现</h1><a id="logo" href="/.">L2M2</a><p class="description">把简单的事情做好</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于Vue.js的后台管理系统的权限实现</h1><div class="post-meta">Apr 13, 2021<span> | </span><span class="category"><a href="/categories/Web前端/">Web前端</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#权限访问控制模型"><span class="toc-text">权限访问控制模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#权限设计：初步方案"><span class="toc-text">权限设计：初步方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：权限配置"><span class="toc-text">实现：权限配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#权限配置上传工具"><span class="toc-text">权限配置上传工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：路由表配置"><span class="toc-text">实现：路由表配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：路由钩子"><span class="toc-text">实现：路由钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：Store"><span class="toc-text">实现：Store</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：操作权限控制"><span class="toc-text">实现：操作权限控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现：动态导航菜单"><span class="toc-text">实现：动态导航菜单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#回顾一下"><span class="toc-text">回顾一下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol></div></div><div class="post-content"><h2 id="权限访问控制模型"><a href="#权限访问控制模型" class="headerlink" title="权限访问控制模型"></a>权限访问控制模型</h2><p>采用RBAC，即Role-based access control，基于角色的访问控制。</p>
<p>每个用户关联一个或多个角色，每个角色关联一个或多个权限，从而可以实现了非常灵活的权限管理。如下图。</p>
<p><img src="/images/casbin-2.png" alt></p>
<p>更多的权限访问控制模型参考<a href="https://l2m2.top/2020/07/19/2020-07-19-casbin/">这里</a>。</p>
<h2 id="权限设计：初步方案"><a href="#权限设计：初步方案" class="headerlink" title="权限设计：初步方案"></a>权限设计：初步方案</h2><p>采用Ant Design Pro中的<a href="https://pro.antdv.com/docs/authority-management" target="_blank" rel="noopener">默认方案</a>, 即前端固定路由表和权限配置，通过后端接口获取到用户拥有的权限代码，来识别是否拥有路由权限或操作权限。</p>
<p>大概的流程如下：</p>
<p><img src="/images/vue-admin-permission-1.png" alt></p>
<h2 id="实现：权限配置"><a href="#实现：权限配置" class="headerlink" title="实现：权限配置"></a>实现：权限配置</h2><p>需要考虑的点：</p>
<ol>
<li>权限配置需要支持国际化</li>
<li>大多数模块的权限都有增删改查</li>
</ol>
<p>最终实现：</p>
<ol>
<li><p>用文件目录结构体现权限层次</p>
<p>层次固定为3级</p>
<p>第一级为大分类，例如系统设置、功能配置等</p>
<p>第二级为模块名称，例如用户管理、角色管理等</p>
<p>第三级为具体的 Action，例如新增、修改、删除、读取等</p>
</li>
<li><p>配置</p>
<p>固定在permissions目录下编写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">|--permissions/</span><br><span class="line">|  |--admin/</span><br><span class="line">|  |  |--user.json</span><br><span class="line">|  |  |--role.json</span><br></pre></td></tr></table></figure>

<p>权限的第一级是permissions下的子目录(例如admin)。</p>
<p>权限的第二级是配置文件的文件名。</p>
<p>权限的第三级在JSON中书写，例如<code>[&quot;read&quot;, &quot;create&quot;, &quot;edit&quot;, &quot;delete&quot;]</code>,由于通常增删查改是模块的基础权限，支持<code>&quot;CRUD&quot;</code>表示增删查改来简化配置, 也支持用CRUD的子集来表示部分权限，比如<code>&quot;R&quot;</code>表示仅有读取的权限。</p>
</li>
<li><p>翻译</p>
<p>在<code>locales/permissions.i18n.js</code>中进行翻译配置。</p>
<p>CRUD四种基础权限不用翻译。</p>
</li>
</ol>
<h2 id="权限配置上传工具"><a href="#权限配置上传工具" class="headerlink" title="权限配置上传工具"></a>权限配置上传工具</h2><p>我们需要写一个权限配置上传工具来将上传到后端数据库。</p>
<p>步骤：</p>
<ol>
<li>获取所有权限code</li>
<li>写入数据库</li>
</ol>
<p>我用python写了一个，大概长这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_all_permissions_code</span><span class="params">()</span>:</span></span><br><span class="line">  files = [y <span class="keyword">for</span> x <span class="keyword">in</span> os.walk(PERMISSION_CONF_DIR) <span class="keyword">for</span> y <span class="keyword">in</span> glob.glob(os.path.join(x[<span class="number">0</span>], <span class="string">'*.json'</span>))]</span><br><span class="line">  total = []</span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">    match = re.search(re.compile(PERMISSION_CONF_DIR + <span class="string">"/(.*?).json"</span>), file)</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">      prefix = match.group(<span class="number">1</span>)</span><br><span class="line">      items = []</span><br><span class="line">      <span class="keyword">with</span> open(file, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> json.load(f):</span><br><span class="line">          crud_match = re.search(<span class="string">r'^[CRUD]+$'</span>, item)</span><br><span class="line">          <span class="keyword">if</span> crud_match:</span><br><span class="line">            <span class="keyword">for</span> crud_item <span class="keyword">in</span> crud_match.group(<span class="number">0</span>):</span><br><span class="line">              <span class="keyword">if</span> crud_item == <span class="string">"C"</span>:</span><br><span class="line">                items.append(<span class="string">"create"</span>)</span><br><span class="line">              <span class="keyword">elif</span> crud_item == <span class="string">"R"</span>:</span><br><span class="line">                items.append(<span class="string">"read"</span>)</span><br><span class="line">              <span class="keyword">elif</span> crud_item == <span class="string">"U"</span>:</span><br><span class="line">                items.append(<span class="string">"update"</span>)</span><br><span class="line">              <span class="keyword">elif</span> crud_item == <span class="string">"D"</span>:</span><br><span class="line">                items.append(<span class="string">"delete"</span>)</span><br><span class="line">      total = total + [<span class="string">'.'</span>.join(<span class="string">f"<span class="subst">&#123;prefix&#125;</span>/<span class="subst">&#123;x&#125;</span>"</span>.split(<span class="string">'/'</span>)) <span class="keyword">for</span> x <span class="keyword">in</span> items]</span><br><span class="line">  <span class="keyword">return</span> total</span><br></pre></td></tr></table></figure>

<p>上传后我们数据库的权限表大概长这样：</p>
<p><img src="/images/vue-admin-permission-2.png" alt></p>
<h2 id="实现：路由表配置"><a href="#实现：路由表配置" class="headerlink" title="实现：路由表配置"></a>实现：路由表配置</h2><p>除了动态生成的路由，我们有一些基础的不需要动态的路由，例如登录：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> basicRouters = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/user"</span>,</span><br><span class="line">    component: UserLayout,</span><br><span class="line">    redirect: <span class="string">"/user/login"</span>,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"login"</span>,</span><br><span class="line">        name: <span class="string">"login"</span>,</span><br><span class="line">        component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/login/Login"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/404"</span>,</span><br><span class="line">    component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/exception/404"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在动态路由的配置中，我们可以在meta中进行权限配置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dynamicRouters = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"/"</span>,</span><br><span class="line">    name: <span class="string">"index"</span>,</span><br><span class="line">    component: BasicLayout,</span><br><span class="line">    meta: &#123; <span class="attr">title</span>: <span class="string">"menu.home"</span> &#125;,</span><br><span class="line">    redirect: <span class="string">"/dashboard"</span>,</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"/dashboard"</span>,</span><br><span class="line">        name: <span class="string">"dashboard"</span>,</span><br><span class="line">        component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/dash/Dashboard"</span>),</span><br><span class="line">        meta: &#123; <span class="attr">title</span>: <span class="string">"menu.dashboard"</span>, <span class="attr">icon</span>: <span class="string">"dashboard"</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">"/admin"</span>,</span><br><span class="line">        component: RouteView,</span><br><span class="line">        meta: &#123; <span class="attr">title</span>: <span class="string">"menu.admin.default"</span>, <span class="attr">icon</span>: <span class="string">"setting"</span> &#125;,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            path: <span class="string">"/admin/user"</span>,</span><br><span class="line">            name: <span class="string">"user"</span>,</span><br><span class="line">            component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/admin/user/User"</span>),</span><br><span class="line">            meta: &#123; <span class="attr">title</span>: <span class="string">"menu.admin.user"</span>, <span class="attr">permission</span>: [<span class="string">"admin.user.read"</span>] &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            path: <span class="string">"/admin/role"</span>,</span><br><span class="line">            name: <span class="string">"role"</span>,</span><br><span class="line">            component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">"@/views/admin/role/Role"</span>),</span><br><span class="line">            meta: &#123; <span class="attr">title</span>: <span class="string">"menu.admin.role"</span>, <span class="attr">permission</span>: [<span class="string">"admin.role.read"</span>] &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">"*"</span>,</span><br><span class="line">    redirect: <span class="string">"/404"</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h2 id="实现：路由钩子"><a href="#实现：路由钩子" class="headerlink" title="实现：路由钩子"></a>实现：路由钩子</h2><p>我们将动态生成路由的逻辑放在路由钩子中。</p>
<p>大概长这样：</p>
<p><code>router/router-hook.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> allowList = [<span class="string">"login"</span>];</span><br><span class="line"><span class="keyword">const</span> loginRoutePath = <span class="string">"/user/login"</span>;</span><br><span class="line"><span class="keyword">const</span> defaultRoutePath = <span class="string">"/dashboard"</span>;</span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (store.getters.token) &#123;</span><br><span class="line">    <span class="keyword">if</span> (to.path === loginRoutePath) &#123;</span><br><span class="line">      next(&#123; <span class="attr">path</span>: defaultRoutePath &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (store.getters.additionalRouters.length === <span class="number">0</span>) &#123;</span><br><span class="line">        store</span><br><span class="line">          .dispatch(<span class="string">"user/getUserInfo"</span>)</span><br><span class="line">          .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> permissions = res.permissions;</span><br><span class="line">            store.dispatch(<span class="string">"permission/generateRouters"</span>, &#123; permissions &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">              store.getters.additionalRouters.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">                router.addRoute(item);</span><br><span class="line">              &#125;);</span><br><span class="line">              <span class="keyword">const</span> redirect = <span class="built_in">decodeURIComponent</span>(<span class="keyword">from</span>.query.redirect || to.path);</span><br><span class="line">              <span class="keyword">if</span> (to.path === redirect) &#123;</span><br><span class="line">                next(&#123; ...to, <span class="attr">replace</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                next(&#123; <span class="attr">path</span>: redirect &#125;);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            store.dispatch(<span class="string">"user/logout"</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">              next(&#123; <span class="attr">path</span>: loginRoutePath, <span class="attr">query</span>: &#123; <span class="attr">redirect</span>: to.fullPath &#125; &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (allowList.includes(to.name)) &#123;</span><br><span class="line">      next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next(&#123; <span class="attr">path</span>: loginRoutePath, <span class="attr">query</span>: &#123; <span class="attr">redirect</span>: to.fullPath &#125; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="实现：Store"><a href="#实现：Store" class="headerlink" title="实现：Store"></a>实现：Store</h2><p>在Store中实现动态路由的逻辑并存储动态的路由表</p>
<p><code>store/modules/permission.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasPermission</span>(<span class="params">router, permissions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (router.meta &amp;&amp; router.meta.permission) &#123;</span><br><span class="line">    <span class="keyword">return</span> !router.meta.permission.some(<span class="function"><span class="params">val</span> =&gt;</span> permissions.indexOf(val) === <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterRouters</span>(<span class="params">routers, permissions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> accessedRouters = routers.filter(<span class="function"><span class="params">router</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasPermission(router, permissions)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (router.children &amp;&amp; router.children.length) &#123;</span><br><span class="line">        router.children = filterRouters(router.children, permissions);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> accessedRouters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  routers: basicRouters,</span><br><span class="line">  additionalRouters: []</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  SET_ROUTERS: <span class="function">(<span class="params">state, routers</span>) =&gt;</span> &#123;</span><br><span class="line">    state.additionalRouters = routers;</span><br><span class="line">    state.routers = basicRouters.concat(routers);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  generateRouters(&#123; commit &#125;, data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; permissions &#125; = data;</span><br><span class="line">      <span class="keyword">const</span> accessedRouters = store.getters.username === <span class="string">"admin"</span> ? dynamicRouters : filterRouters(_cloneDeep(dynamicRouters), permissions);</span><br><span class="line">      commit(<span class="string">"SET_ROUTERS"</span>, accessedRouters);</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="实现：操作权限控制"><a href="#实现：操作权限控制" class="headerlink" title="实现：操作权限控制"></a>实现：操作权限控制</h2><p>我们可以给Vue注册一个全局方法，用来验证是否有权限。</p>
<p>写一个插件。</p>
<p><code>plugin\auth.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> plugin = &#123;</span><br><span class="line">  install: <span class="function">(<span class="params">Vue, &#123; store &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!store) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Please provide vuex store."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Vue.prototype.$auth = <span class="function"><span class="keyword">function</span>(<span class="params">permissions</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (store.getters.username === <span class="string">"admin"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> !permissions.some(<span class="function"><span class="params">val</span> =&gt;</span> store.getters.permissions.indexOf(val) === <span class="number">-1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> plugin;</span><br></pre></td></tr></table></figure>

<p>这样，我们可以在模版中对组件进行权限控制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;button v-if=&quot;$auth([&apos;code1&apos;])&quot;&gt;</span><br><span class="line">  Test</span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure>

<p>为了避免与组件本身的v-if逻辑混在一起写，我们推荐使用指令的方式来实现。</p>
<p>大同小异，我们定义一个auth指令。</p>
<p><code>directives/auth.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"@/store"</span>;</span><br><span class="line"><span class="keyword">const</span> auth = Vue.directive(<span class="string">"auth"</span>, &#123;</span><br><span class="line">  inserted: <span class="function"><span class="keyword">function</span>(<span class="params">el, binding</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (store.getters.username === <span class="string">"admin"</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> permissions = binding.value;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> permissions === <span class="string">"string"</span>) &#123;</span><br><span class="line">      permissions = [permissions];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (permissions.some(<span class="function"><span class="params">val</span> =&gt;</span> store.getters.permissions.indexOf(val) === <span class="number">-1</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (el.parentNode) &#123;</span><br><span class="line">        el.parentNode.removeChild(el);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        el.style.display = <span class="string">"none"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> auth;</span><br></pre></td></tr></table></figure>

<p>在模版中进行权限控制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;button v-auth=&quot;&apos;admin.user.create&apos;&quot;&gt;</span><br><span class="line">  Test</span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure>

<h2 id="实现：动态导航菜单"><a href="#实现：动态导航菜单" class="headerlink" title="实现：动态导航菜单"></a>实现：动态导航菜单</h2><p>我们可以使用上面过滤后的动态路由来生成菜单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">  ...mapState(&#123;</span><br><span class="line">    mainMenu: <span class="function"><span class="params">state</span> =&gt;</span> state.permission.additionalRouters</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br><span class="line">created() &#123;</span><br><span class="line">    <span class="keyword">const</span> routes = <span class="keyword">this</span>.mainMenu.find(<span class="function"><span class="params">item</span> =&gt;</span> item.path === <span class="string">"/"</span>);</span><br><span class="line">    <span class="keyword">this</span>.menus = (routes &amp;&amp; routes.children) || [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="回顾一下"><a href="#回顾一下" class="headerlink" title="回顾一下"></a>回顾一下</h2><p>回顾一下，主要包括以下几部分。</p>
<ul>
<li>权限配置：更简化的配置，使用自动化工具上传权限。</li>
<li>动态路由：在路由钩子中实现。</li>
<li>操作权限控制：使用指令。</li>
<li>动态导航菜单：通过动态路由生成。</li>
</ul>
<p>完整的实现在<a href="https://github.com/l2m2/fastapi-vue-admin" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://pro.antdv.com/docs/authority-management" target="_blank" rel="noopener">https://pro.antdv.com/docs/authority-management</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://l2m2.top/2021/04/13/2021-04-13-vue-admin-permission/" data-id="cm8istm2400i5egq6jkoqly58" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLElEQVR42u3aQY7DIAwF0N7/0h1pttPQb0NGCjxWVZM2eSwsY/v1itf7d119c3X17/dX9ye/WrAwMDAey3gP1/ilx4CZq/m7YWBgnMMYh8UENn65XjguhGwMDAyMISlPH78ETQwMDIylAbeX0uVXMTAwMHqH2N6deWUsD9MYGBinMaqNgf/8fGN/AwMD4yGMd3GNQ2r18b2w/uHpGBgYWzOSMll1SKJ3HE227MtmYWBgHMPIi/sJYG3Ls5m9YmBgbMRIylj5mFc+8tVrXkZVQwwMjK0Z1SB7X2uzEKwxMDA2ZeTFspl2Y54sNg/SGBgYWzPmC2G9ZuSY1yzhYWBgbMqojljNFNqq6WNhcA0DA+MARhI080RtvpFZPQxjYGDszZgPkUkzMr8zb69iYGCcycgfn6zquEZedCuU2zAwMDZiVEcf8hZmr6nZG1DDwMA4mbHq+No70OYJKwYGxq6M6rBFnszN/FuyHR9amBgYGJsyqkfZmbBbHvO670SOgYHxKEZ+BO0Ne+XjGjMhHgMD4wTGTGMyL67l7YE8cF9muBgYGBsx8kJ/3ubsBdzqpkR7hoGBsQWjN0KRB+Jeyaw6uoGBgbE3I1/VJDIn9YY8MDAwTmPkr1VN8pJ/W9WQwMDAOIFRLeLPw6qxv9AewMDAOJhRLdXNjFzkW4aBgYFR/ZyAq4WzqI2KgYFxAKPXDMgHI3pty2WNTAwMjIcz7mgMVMNxPvYxhcHAwHge4wcz+hkG081RtgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Vue-js/">Vue.js</a><a href="/tags/权限设计/">权限设计</a></div><div class="post-nav"><a class="pre" href="/2021/05/06/2021-05-06-fix-rpmdb-error/">解决yum install时出现Thread died in Berkeley DB library的错误</a><a class="next" href="/2021/04/07/2021-04-07-verdaccio-package-not-found/">解决Verdaccio找不到包的问题</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '063f09497ab2295cd574',
  clientSecret: '511f140355c2df260b5b0f85f1e8decdf4eeb1a3',
  repo: 'l2m2.github.io',
  owner: 'l2m2',
  admin: ['l2m2'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://l2m2.top"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web前端/">Web前端</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">31</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Vuetify/" style="font-size: 15px;">Vuetify</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/面试题目/" style="font-size: 15px;">面试题目</a> <a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/Qt/" style="font-size: 15px;">Qt</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/VS-Code/" style="font-size: 15px;">VS Code</a> <a href="/tags/H5/" style="font-size: 15px;">H5</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a> <a href="/tags/PostgreSQL/" style="font-size: 15px;">PostgreSQL</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/MSSQL/" style="font-size: 15px;">MSSQL</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/GitLab/" style="font-size: 15px;">GitLab</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/MacOS/" style="font-size: 15px;">MacOS</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/pdf/" style="font-size: 15px;">pdf</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/Wall/" style="font-size: 15px;">Wall</a> <a href="/tags/Casbin/" style="font-size: 15px;">Casbin</a> <a href="/tags/TOML/" style="font-size: 15px;">TOML</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/PM2/" style="font-size: 15px;">PM2</a> <a href="/tags/WordPress/" style="font-size: 15px;">WordPress</a> <a href="/tags/OCR/" style="font-size: 15px;">OCR</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/Vue-js/" style="font-size: 15px;">Vue.js</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/SQLAlchemy/" style="font-size: 15px;">SQLAlchemy</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/iconfont/" style="font-size: 15px;">iconfont</a> <a href="/tags/Verdaccio/" style="font-size: 15px;">Verdaccio</a> <a href="/tags/MFC/" style="font-size: 15px;">MFC</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/NSIS/" style="font-size: 15px;">NSIS</a> <a href="/tags/Duilib/" style="font-size: 15px;">Duilib</a> <a href="/tags/VSTO/" style="font-size: 15px;">VSTO</a> <a href="/tags/PowerPoint插件/" style="font-size: 15px;">PowerPoint插件</a> <a href="/tags/COM/" style="font-size: 15px;">COM</a> <a href="/tags/VBScript/" style="font-size: 15px;">VBScript</a> <a href="/tags/Office/" style="font-size: 15px;">Office</a> <a href="/tags/MSVC/" style="font-size: 15px;">MSVC</a> <a href="/tags/wkhtmltopdf/" style="font-size: 15px;">wkhtmltopdf</a> <a href="/tags/OpenCV/" style="font-size: 15px;">OpenCV</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/SikuliX/" style="font-size: 15px;">SikuliX</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/ChatGPT/" style="font-size: 15px;">ChatGPT</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Midjourney/" style="font-size: 15px;">Midjourney</a> <a href="/tags/AutoIt/" style="font-size: 15px;">AutoIt</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/QML/" style="font-size: 15px;">QML</a> <a href="/tags/WSL/" style="font-size: 15px;">WSL</a> <a href="/tags/权限设计/" style="font-size: 15px;">权限设计</a> <a href="/tags/cef/" style="font-size: 15px;">cef</a> <a href="/tags/CMake/" style="font-size: 15px;">CMake</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/12/19/2024-12-19-windows-xp-vmware-expire/">解决VMware虚拟机中的Windows XP到期无法使用的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/11/19/2024-11-19-systemctl-on-wsl/">解决WSL的CentOS无法正常使用systemctl</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/06/2024-08-06-use-pg_partman/">windows下使用pg_partman实现PostgreSQL 15自动分区</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/02/2024-02-02-qml-row-vs-rowlayout/">QML中的Row与RowLayout</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/11/21/2023-11-21-qt-charts-for-5.6/">Qt5.6编译QtCharts</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/26/2023-06-26-retinanet-training/">基于RetinaNet训练模型以及检测图像中的对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/21/2023-06-21-imageai-custom-training/">使用ImageAI训练自定义模型以及检测图像中的对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/18/2023-05-18-autoit-access-db/">AutoIt操作Access数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/12/2023-05-12-autoit-postgresql/">AutoIt操作PostgreSQL数据库</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/10/2023-05-10-qt-for-android-env-build/">搭建Qt for Android开发环境</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://wuming.me/" title="无名的旅人" target="_blank">无名的旅人</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">L2M2.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>